<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chessboard with Fabric.js</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
  <style>
    .game-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
    }
    .side-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 20px;
      background-color: #f0f0f0;
      border-radius: 10px;
    }
    .toggle-button {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .toggle-button:hover {
      background-color: #1976D2;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react,stage-3">
    
    const initialGameState = [
      ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
      ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
      ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
    ];

    const pieceImages = {
      'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
      'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
      'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
      'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
      'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
      'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
      'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
      'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
      'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
      'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
      'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
      'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg'
    };

    // Chessboard and piece handling with Fabric.js
    function Game() {
      const [game, setGame] = React.useState(initialGameState);
      const [selectedSquare, setSelectedSquare] = React.useState(null);
      const [isWhiteTurn, setIsWhiteTurn] = React.useState(true);
      const [winner, setWinner] = React.useState(null);
      const [isSpeechEnabled, setIsSpeechEnabled] = React.useState(false);

      const canvasRef = React.useRef(null);

      React.useEffect(() => {
        const canvas = new fabric.Canvas('chessboard', { width: 640, height: 640 });
        canvasRef.current = canvas;

        // Initialize chessboard
        drawBoard(canvas);
        drawPieces(canvas, game);

        canvas.on('mouse:down', function (options) {
          const pointer = canvas.getPointer(options.e);
          const row = Math.floor(pointer.y / 80);
          const col = Math.floor(pointer.x / 80);
          handleSquareClick(row, col);
        });

        return () => {
          canvas.dispose();
        };
      }, [game]);

      function drawBoard(canvas) {
        canvas.clear(); // Clear existing canvas content
        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const isLightSquare = (row + col) % 2 === 0;
            const squareColor = isLightSquare ? '#f0d9b5' : '#b58863';
            const square = new fabric.Rect({
              left: col * 80,
              top: row * 80,
              width: 80,
              height: 80,
              fill: squareColor,
              selectable: false
            });
            canvas.add(square);
          }
        }
      }

      function drawPieces(canvas, game) {
        for (let row = 0; row < game.length; row++) {
          for (let col = 0; col < game[row].length; col++) {
            const piece = game[row][col];
            if (piece) {
              fabric.Image.fromURL(pieceImages[piece], function (img) {
                img.set({
                  left: col * 80,
                  top: row * 80,
                  width: 80,
                  height: 80,
                  selectable: false
                });
                canvas.add(img);
              });
            }
          }
        }
      }

      function handleSquareClick(row, col) {
        if (winner) return;
        if (selectedSquare) {
          const newGame = game.map(row => row.slice());
          const [selectedRow, selectedCol] = selectedSquare;
          const piece = newGame[selectedRow][selectedCol];
          const isValid = isValidMove(piece, selectedRow, selectedCol, row, col, game);
          if (isValid) {
            newGame[row][col] = piece;
            newGame[selectedRow][selectedCol] = '';
            setGame(newGame);
            setSelectedSquare(null);
            setIsWhiteTurn(!isWhiteTurn);
          }
        } else {
          const piece = game[row][col];
          if (piece && ((isWhiteTurn && piece === piece.toUpperCase()) || (!isWhiteTurn && piece === piece.toLowerCase()))) {
            setSelectedSquare([row, col]);
          }
        }
      }

      function restartGame() {
        setGame(initialGameState);
        setSelectedSquare(null);
        setIsWhiteTurn(true);
        setWinner(null);
        const canvas = canvasRef.current;
        drawBoard(canvas);
        drawPieces(canvas, initialGameState);
      }

      return (
        <div className="game-container">
          <canvas id="chessboard"></canvas>
          <div className="side-panel">
            <button onClick={restartGame}>Restart Game</button>
            {winner ? <div>{winner} wins!</div> : <div>{isWhiteTurn ? "White's turn" : "Black's turn"}</div>}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<Game />);
  </script>
</body>
</html>

