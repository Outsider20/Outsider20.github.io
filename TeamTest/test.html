import { useState, useEffect, useRef } from 'react';
import { Gem, Target, RefreshCw, Play, Info, Settings, Home, Volume2, Music } from 'lucide-react';
import { Button } from '@/components/ui/button';

const BOARD_SIZE = 6;
const COLORS = ['red', 'blue', 'green', 'purple', 'orange'];
const MIN_MATCH = 3;
const TILE_SIZE = 48;
const TILE_GAP = 4;

const getRandomColor = () => COLORS[Math.floor(Math.random() * COLORS.length)];

const SlashedIcon = ({ icon: Icon, ...props }) => (
  <div className="relative">
    <Icon {...props} />
    <div className="absolute inset-0 flex items-center justify-center">
      <div className="w-[140%] h-0.5 bg-current rotate-45 transform origin-center" />
    </div>
  </div>
);

const MenuBox = ({ children }) => (
  <div className="absolute inset-0 bg-white/95 backdrop-blur-sm flex items-center justify-center">
    <div className="bg-white rounded-xl shadow-lg p-6 max-w-[280px] w-full">
      {children}
    </div>
  </div>
);

const StartMenu = ({ onStartGame, onShowInstructions, onShowSettings }) => (
  <MenuBox>
    <div className="flex flex-col items-center gap-6">
      <div className="flex items-center gap-2 text-2xl font-bold">
        <Gem className="text-purple-500" size={32} />
        Color Chain
      </div>
      <div className="w-full space-y-3">
        <Button 
          onClick={onStartGame}
          className="w-full flex items-center justify-center gap-2"
        >
          <Play size={20} />
          Play Game
        </Button>
        <Button 
          variant="outline"
          onClick={onShowInstructions}
          className="w-full flex items-center justify-center gap-2"
        >
          <Info size={20} />
          How to Play
        </Button>
        <Button 
          variant="outline"
          onClick={onShowSettings}
          className="w-full flex items-center justify-center gap-2"
        >
          <Settings size={20} />
          Settings
        </Button>
      </div>
    </div>
  </MenuBox>
);

const Instructions = ({ onBack }) => (
  <MenuBox>
    <div className="flex flex-col gap-4">
      <div className="text-xl font-bold text-center">How to Play</div>
      <div className="space-y-3 text-sm">
        <p className="flex items-center gap-2">
          <span className="bg-purple-100 p-1 rounded">1</span>
          Click and drag to connect matching colors
        </p>
        <p className="flex items-center gap-2">
          <span className="bg-purple-100 p-1 rounded">2</span>
          Connect at least 3 tiles to make a match
        </p>
        <p className="flex items-center gap-2">
          <span className="bg-purple-100 p-1 rounded">3</span>
          You can move diagonally!
        </p>
        <p className="flex items-center gap-2">
          <span className="bg-purple-100 p-1 rounded">4</span>
          Longer chains = more points
        </p>
        <p className="flex items-center gap-2">
          <span className="bg-purple-100 p-1 rounded">5</span>
          Clear tiles before running out of moves
        </p>
      </div>
      <Button 
        onClick={onBack}
        className="w-full flex items-center justify-center gap-2"
      >
        <Home size={20} />
        Back to Menu
      </Button>
    </div>
  </MenuBox>
);

const Settings = ({ settings, onUpdateSettings, onBack }) => (
  <MenuBox>
    <div className="flex flex-col gap-4">
      <div className="text-xl font-bold text-center">Settings</div>
      <div className="space-y-4">
        <Button
          variant="outline"
          className="w-full flex items-center justify-between"
          onClick={() => onUpdateSettings({ ...settings, sfx: !settings.sfx })}
        >
          <span>Sound Effects</span>
          {settings.sfx ? <Volume2 size={20} /> : <SlashedIcon icon={Volume2} size={20} />}
        </Button>
        <Button
          variant="outline"
          className="w-full flex items-center justify-between"
          onClick={() => onUpdateSettings({ ...settings, music: !settings.music })}
        >
          <span>Background Music</span>
          {settings.music ? <Music size={20} /> : <SlashedIcon icon={Music} size={20} />}
        </Button>
      </div>
      <Button 
        onClick={onBack}
        className="w-full flex items-center justify-center gap-2"
      >
        <Home size={20} />
        Back to Menu
      </Button>
    </div>
  </MenuBox>
);

const PauseMenu = ({ onResume, onRestart, onMainMenu }) => (
  <MenuBox>
    <div className="flex flex-col gap-4">
      <div className="text-xl font-bold text-center">Game Paused</div>
      <div className="space-y-3">
        <Button 
          onClick={onResume}
          className="w-full flex items-center justify-center gap-2"
        >
          <Play size={20} />
          Resume Game
        </Button>
        <Button 
          variant="outline"
          onClick={onRestart}
          className="w-full flex items-center justify-center gap-2"
        >
          <RefreshCw size={20} />
          Restart Game
        </Button>
        <Button 
          variant="outline"
          onClick={onMainMenu}
          className="w-full flex items-center justify-center gap-2"
        >
          <Home size={20} />
          Main Menu
        </Button>
      </div>
    </div>
  </MenuBox>
);

const Game = ({ onBack, settings }) => {
  const [board, setBoard] = useState([]);
  const [isDragging, setIsDragging] = useState(false);
  const [selectedTiles, setSelectedTiles] = useState(new Set());
  const [score, setScore] = useState(0);
  const [moves, setMoves] = useState(15);
  const [gameOver, setGameOver] = useState(false);
  const [isPaused, setIsPaused] = useState(false);
  const lastTile = useRef(null);
  const boardRef = useRef(null);
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 });

  const initializeBoard = () => {
    const newBoard = Array(BOARD_SIZE).fill().map(() => 
      Array(BOARD_SIZE).fill().map(() => getRandomColor())
    );
    setBoard(newBoard);
    setScore(0);
    setMoves(15);
    setGameOver(false);
    setIsPaused(false);
    setSelectedTiles(new Set());
  };

  useEffect(() => {
    initializeBoard();
  }, []);

  const handleTileMouseDown = (row, col, e) => {
    if (gameOver || isPaused) return;
    
    const tileColor = board[row][col];
    setIsDragging(true);
    setSelectedTiles(new Set([`${row}-${col}`]));
    lastTile.current = { row, col, color: tileColor };
    
    const rect = boardRef.current.getBoundingClientRect();
    setMousePos({
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    });
  };

  const handleTileMouseEnter = (row, col) => {
    if (!isDragging || gameOver || isPaused) return;
    
    const currentTile = { row, col, color: board[row][col] };
    
    const isAdjacent = Math.abs(currentTile.row - lastTile.current.row) <= 1 &&
                       Math.abs(currentTile.col - lastTile.current.col) <= 1;
    
    if (isAdjacent && currentTile.color === lastTile.current.color) {
      setSelectedTiles(prev => new Set([...prev, `${row}-${col}`]));
      lastTile.current = currentTile;
    }
  };

  const handleMouseMove = (e) => {
    if (isDragging) {
      const rect = boardRef.current.getBoundingClientRect();
      setMousePos({
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      });
    }
  };

  const handleMouseUp = () => {
    if (!isDragging) return;
    
    if (selectedTiles.size >= MIN_MATCH) {
      const pointsPerTile = 10;
      const chainBonus = Math.floor(selectedTiles.size / MIN_MATCH);
      const points = selectedTiles.size * pointsPerTile * chainBonus;
      
      setScore(prev => prev + points);
      setMoves(prev => prev - 1);
      
      const newBoard = [...board];
      selectedTiles.forEach(pos => {
        const [row, col] = pos.split('-').map(Number);
        for (let i = row; i > 0; i--) {
          newBoard[i][col] = newBoard[i-1][col];
        }
        newBoard[0][col] = getRandomColor();
      });
      
      setBoard(newBoard);
      
      if (moves <= 1) {
        setGameOver(true);
      }
    }
    
    setIsDragging(false);
    setSelectedTiles(new Set());
    lastTile.current = null;
  };

  const renderConnectionLines = () => {
    if (!isDragging || selectedTiles.size < 2) return null;

    const tiles = Array.from(selectedTiles).map(pos => {
      const [row, col] = pos.split('-').map(Number);
      return {
        x: col * (TILE_SIZE + TILE_GAP) + TILE_SIZE / 2,
        y: row * (TILE_SIZE + TILE_GAP) + TILE_SIZE / 2
      };
    });

    const pathPoints = tiles.map((point, i) => 
      i === 0 ? `M ${point.x} ${point.y}` : `L ${point.x} ${point.y}`
    ).join(' ');

    return (
      <svg className="absolute inset-0 pointer-events-none" style={{ zIndex: 10 }}>
        <path
          d={pathPoints}
          stroke="yellow"
          strokeWidth="4"
          fill="none"
          strokeLinecap="round"
          strokeLinejoin="round"
          opacity="0.5"
        />
      </svg>
    );
  };

  return (
    <div className="relative">
      <div className="flex flex-col items-center gap-4 p-4">
        <div className="flex gap-4 mb-4">
          <Button 
            variant="outline" 
            size="sm"
            onClick={() => setIsPaused(true)}
            className="flex items-center gap-2"
          >
            <Settings size={16} />
            Pause
          </Button>
          <div className="flex items-center gap-2">
            <Gem className="text-purple-500" />
            <span className="font-bold">Score: {score}</span>
          </div>
          <div className="flex items-center gap-2">
            <Target className="text-red-500" />
            <span className="font-bold">Moves: {moves}</span>
          </div>
        </div>

        <div 
          ref={boardRef}
          className="grid gap-1 p-2 bg-gray-100 rounded-lg relative"
          onMouseUp={handleMouseUp}
          onMouseLeave={handleMouseUp}
          onMouseMove={handleMouseMove}
        >
          {renderConnectionLines()}
          {board.map((row, rowIndex) => (
            <div key={rowIndex} className="flex gap-1">
              {row.map((color, colIndex) => (
                <button
                  key={`${rowIndex}-${colIndex}`}
                  className={`w-12 h-12 rounded-lg transition-all duration-200 ${
                    selectedTiles.has(`${rowIndex}-${colIndex}`)
                      ? 'ring-4 ring-yellow-400 scale-110'
                      : ''
                  } hover:brightness-110`}
                  style={{ backgroundColor: color }}
                  onMouseDown={(e) => handleTileMouseDown(rowIndex, colIndex, e)}
                  onMouseEnter={() => handleTileMouseEnter(rowIndex, colIndex)}
                  disabled={gameOver || isPaused}
                />
              ))}
            </div>
          ))}

          {gameOver && (
            <MenuBox>
              <div className="flex flex-col gap-4">
                <div className="text-xl font-bold text-center">Game Over!</div>
                <div className="text-center">Final Score: {score}</div>
                <div className="space-y-3">
                  <Button 
                    onClick={initializeBoard}
                    className="w-full flex items-center justify-center gap-2"
                  >
                    <RefreshCw size={20} />
                    Play Again
                  </Button>
                  <Button 
                    variant="outline"
                    onClick={onBack}
                    className="w-full flex items-center justify-center gap-2"
                  >
                    <Home size={20} />
                    Main Menu
                  </Button>
                </div>
              </div>
            </MenuBox>
          )}

          {isPaused && (
            <PauseMenu 
              onResume={() => setIsPaused(false)}
              onRestart={initializeBoard}
              onMainMenu={onBack}
            />
          )}
        </div>
      </div>
    </div>
  );
};

const Match3Game = () => {
  const [currentScreen, setCurrentScreen] = useState('menu');
  const [settings, setSettings] = useState({
    sfx: true,
    music: true
  });

  return (
    <div className="flex items-center justify-center min-h-[600px]">
      <div className="relative w-[400px] h-[500px] bg-gray-100 rounded-lg">
        {currentScreen === 'menu' && (
          <StartMenu 
            onStartGame={() => setCurrentScreen('game')}
            onShowInstructions={() => setCurrentScreen('instructions')}
            onShowSettings={() => setCurrentScreen('settings')}
          />
        )}
        {currentScreen === 'instructions' && (
          <Instructions 
            onBack={() => setCurrentScreen('menu')}
          />
        )}
        {currentScreen === 'settings' && (
          <Settings 
            settings={settings}
            onUpdateSettings={setSettings}
            onBack={() => setCurrentScreen('
